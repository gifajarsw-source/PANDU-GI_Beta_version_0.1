<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <title>PANDU-GI | Search Access</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;       
            --primary-dark: #1e40af;
            --bg: #f8fafc;            
            --surface: #ffffff;       
            --text-main: #0f172a;     
            --text-sub: #64748b;      
            --danger: #ef4444;        
            --success: #10b981;       
            --purple: #8b5cf6;        
            --border: #e2e8f0;        
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg); color: var(--text-main); margin: 0; padding-bottom: 80px; }

        /* SEARCH ENGINE LOGIN STYLE */
        #unit-select-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 90vh;
            padding: 20px;
            background: white;
            animation: fadeIn 0.5s ease;
        }

        .search-brand {
            font-size: 32px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 30px;
            letter-spacing: -1px;
            text-align: center;
        }
        
        .search-brand span { color: var(--text-main); }

        .search-wrapper {
            width: 100%;
            max-width: 480px;
            position: relative;
        }

        .search-box {
            width: 100%;
            background: white;
            border: 1px solid #dfe1e5;
            box-shadow: 0 1px 6px rgba(32,33,36,0.1);
            border-radius: 24px;
            display: flex;
            align-items: center;
            padding: 12px 20px;
            transition: all 0.2s;
        }

        .search-box:hover, .search-box:focus-within {
            box-shadow: 0 1px 6px rgba(32,33,36,0.28);
            border-color: rgba(223,225,229,0);
        }

        .search-icon { color: #9aa0a6; margin-right: 15px; }

        .search-input {
            border: none;
            width: 100%;
            font-size: 16px;
            font-family: inherit;
            color: var(--text-main);
            height: 24px;
            padding: 0;
            margin: 0;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 0 0 24px 24px;
            box-shadow: 0 4px 6px rgba(32,33,36,0.28);
            margin-top: -20px;
            padding-top: 20px;
            z-index: 10;
            display: none;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid transparent;
        }

        .search-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: 0.1s;
            border-bottom: 1px solid #f1f5f9;
        }

        .search-item:hover { background: #f8fafc; }
        .search-item:last-child { border-bottom: none; }

        .si-icon {
            width: 32px; 
            height: 32px; 
            background: #eff6ff; 
            color: var(--primary); 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .si-text div:first-child { font-weight: 600; font-size: 14px; color: var(--text-main); }
        .si-text div:last-child { font-size: 11px; color: var(--text-sub); }

        /* GLOBAL STYLES */
        .header { background: var(--surface); padding: 15px 20px; position: sticky; top: 0; z-index: 100; display: none; align-items: center; justify-content: space-between; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border-bottom: 1px solid var(--border); }
        .app-brand { font-weight: 800; font-size: 18px; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .gi-badge { font-size: 10px; background: #eff6ff; color: var(--primary); padding: 4px 8px; border-radius: 6px; font-weight: 700; text-transform: uppercase; border: 1px solid #dbeafe; letter-spacing: 0.5px; }
        .btn-back { display: none; background: #f1f5f9; border: none; padding: 8px 12px; border-radius: 8px; font-weight: 600; font-size: 12px; color: var(--text-sub); cursor: pointer; }

        .container { max-width: 600px; margin: 0 auto; padding: 20px; min-height: 85vh; }

        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; animation: fadeUp 0.4s ease; }
        .menu-card { background: var(--surface); border-radius: 16px; padding: 25px 15px; display: flex; flex-direction: column; align-items: center; text-align: center; box-shadow: var(--shadow); border: 1px solid var(--border); cursor: pointer; transition: transform 0.1s; position: relative; overflow: hidden; }
        .menu-card:active { transform: scale(0.97); background: #f8fafc; border-color: var(--primary); }
        .menu-icon-box { width: 54px; height: 54px; border-radius: 14px; display: flex; align-items: center; justify-content: center; margin-bottom: 12px; font-size: 26px; }
        
        .ic-blue { background: #eff6ff; color: #2563eb; } .ic-green { background: #ecfdf5; color: #10b981; }
        .ic-orange { background: #fff7ed; color: #f97316; } .ic-purple { background: #f5f3ff; color: #8b5cf6; }
        .ic-gray { background: #f8fafc; color: #475569; }
        .menu-full { grid-column: 1 / -1; flex-direction: row; justify-content: flex-start; padding: 20px; gap: 15px; }
        .menu-full .menu-icon-box { margin-bottom: 0; width: 40px; height: 40px; font-size: 20px; } 
        .menu-title { font-weight: 700; font-size: 14px; margin-bottom: 2px; color: var(--text-main); }
        .menu-desc { font-size: 11px; color: var(--text-sub); }

        .app-section { display: none; animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .app-section.active { display: block; }
        .card { background: var(--surface); border-radius: 12px; padding: 16px; margin-bottom: 12px; box-shadow: var(--shadow); border: 1px solid var(--border); position: relative; }
        .card.trip-alarm { border-left: 5px solid var(--danger); background: #fffbfc; }
        .badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; background: #eff6ff; color: var(--primary); margin-bottom: 8px; }
        .card-title { font-size: 16px; font-weight: 800; margin: 0 0 10px 0; color: var(--primary); line-height: 1.4; border-bottom: 1px solid #f1f5f9; padding-bottom: 8px; }
        
        .data-row { margin-bottom: 8px; }
        .data-label { font-size: 11px; font-weight: 700; color: var(--text-sub); text-transform: uppercase; margin-bottom: 2px; }
        .data-val { font-size: 14px; color: var(--text-main); line-height: 1.5; white-space: pre-line; }

        .btn { border: none; padding: 14px; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; margin-bottom: 10px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: #f1f5f9; color: var(--text-main); border: 1px solid #cbd5e1; }
        .btn-danger { background: #fee2e2; color: var(--danger); }
        .btn-success { background: var(--success); color: white; }
        .btn-purple { background: var(--purple); color: white; }
        
        .action-group { position: absolute; top: 12px; right: 12px; display: flex; gap: 8px; }
        .icon-btn { background: white; border: 1px solid var(--border); color: var(--text-sub); width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        
        input, textarea, select { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 10px; font-family: inherit; margin-bottom: 12px; font-size: 14px; background: #fff; }
        .search-bar { position: sticky; top: 70px; z-index: 90; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05); border: 1px solid var(--primary); }
        
        .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 1000; display: none; align-items: flex-end; justify-content: center; }
        .modal { background: white; width: 100%; max-width: 500px; border-radius: 24px 24px 0 0; padding: 24px; max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s ease; }
        
        #loader { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(255,255,255,0.8); backdrop-filter: blur(2px); z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; color: var(--primary); }
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 15px; }
        #toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 3000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; width: 90%; max-width: 400px; }
        .toast { background: #1e293b; color: white; padding: 12px 16px; border-radius: 10px; font-size: 13px; font-weight: 500; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2); animation: fadeUp 0.3s ease; display: flex; align-items: center; gap: 10px; justify-content: center; }
        .toast.error { background: #ef4444; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { opacity: 0; transform: scale(0.96); } to { opacity: 1; transform: scale(1); } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        @media (min-width: 600px) { .overlay { align-items: center; padding: 20px; } .modal { border-radius: 20px; max-height: 85vh; } }
        .empty-state { text-align:center; padding: 40px 0; color: var(--text-sub); font-size: 13px; }
    </style>
</head>
<body>

<div id="unit-select-screen">
    <div class="search-brand">PANDU-<span>GI</span></div>
    <div class="search-wrapper">
        <div class="search-box">
            <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            <input type="text" id="unit-search-input" class="search-input" placeholder="Telusuri Gardu Induk..." autocomplete="off">
        </div>
        <div id="unit-search-results" class="search-results"></div>
    </div>
    <p style="margin-top:20px; font-size:12px; color:#94a3b8">Ketik nama unit atau pilih dari daftar</p>
</div>

<div class="header">
    <div class="app-brand">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20a8 8 0 1 0 0-16 8 8 0 0 0 0 16Z"/><path d="M12 14a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/><path d="M12 2v2"/><path d="M12 22v-2"/><path d="M2 12h2"/><path d="M22 12h-2"/></svg>
        PANDU-GI <span id="header-gi-name" class="gi-badge">APP</span>
    </div>
    <button id="btn-back" class="btn-back" onclick="goHome()">Menu</button>
</div>

<div class="container" id="app-container" style="display:none;">

    <div id="main-menu">
        <div style="margin-bottom: 20px; padding: 0 5px; display:flex; justify-content:space-between; align-items:end;">
            <div>
                <h2 style="margin: 0; font-size: 20px;">Dashboard</h2>
                <p style="margin: 4px 0 0 0; color: var(--text-sub); font-size: 12px;">Unit Aktif: <b id="gi-name-display">...</b></p>
            </div>
            <button onclick="switchUnit()" style="background:none; border:none; color:var(--primary); font-size:12px; font-weight:700; cursor:pointer;">Ganti Unit ‚Ü∫</button>
        </div>

        <div class="menu-grid">
            <div class="menu-card" onclick="openSection('section-annunciator')">
                <div class="menu-icon-box ic-blue"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg></div>
                <div class="menu-title">Cari Annunciator</div><div class="menu-desc">Database Annunciator</div>
            </div>
            <div class="menu-card" onclick="openSection('section-asset')">
                <div class="menu-icon-box ic-purple"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg></div>
                <div class="menu-title">Data Asset</div><div class="menu-desc">Gambar & Manual (PDF)</div>
            </div>
            <div class="menu-card" onclick="openSection('section-sop')">
                <div class="menu-icon-box ic-green"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg></div>
                <div class="menu-title">SOP</div><div class="menu-desc">Instruksi Kerja (PDF)</div>
            </div>
            <div class="menu-card" onclick="openSection('section-contact')">
                <div class="menu-icon-box ic-orange"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg></div>
                <div class="menu-title">Kontak</div><div class="menu-desc">Nomor Penting</div>
            </div>
            <div class="menu-card menu-full" onclick="openSection('section-data')">
                <div class="menu-icon-box ic-gray" style="margin-bottom:0;"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></div>
                <div class="menu-text"><div class="menu-title" style="margin:0">Backup & Reset</div><div class="menu-desc">Pengaturan Aplikasi</div></div>
            </div>
        </div>
    </div>

    <div id="section-annunciator" class="app-section">
        <input type="text" id="search-ann" class="search-bar" placeholder="Cari Annunciator..." oninput="renderAnnunciator()">
        <button class="btn btn-primary" onclick="openModal('modal-ann')">+ Input Annunciator Baru</button>
        <div id="list-ann"></div>
    </div>

    <div id="section-asset" class="app-section">
        <div class="card" style="border-top: 4px solid var(--purple);">
            <h3 class="card-title" style="color:var(--text-main); border:none">Upload Asset (PDF)</h3>
            <p class="card-desc">Simpan manual/gambar. Maksimal 10 MB.</p>
            <input type="text" id="asset-name" placeholder="Judul Asset">
            <input type="file" id="asset-file" accept="application/pdf">
            <button class="btn btn-purple" onclick="saveAsset()">Simpan PDF</button>
        </div>
        <div id="list-asset"></div>
    </div>

    <div id="section-sop" class="app-section">
        <div class="card" style="border-top: 4px solid var(--success);">
            <h3 class="card-title" style="color:var(--text-main); border:none">Upload SOP (PDF)</h3>
            <p class="card-desc">Simpan IK/SOP. Maksimal 10 MB.</p>
            <input type="text" id="sop-name" placeholder="Judul Dokumen">
            <input type="file" id="sop-file" accept="application/pdf">
            <button class="btn btn-success" onclick="saveSOP()">Simpan SOP</button>
        </div>
        <div id="list-sop"></div>
    </div>

    <div id="section-contact" class="app-section">
        <button class="btn btn-primary" onclick="openModal('modal-contact')">+ Tambah Kontak</button>
        <div id="list-contact"></div>
    </div>

    <div id="section-data" class="app-section">
        <div class="card">
            <div class="data-label">Identitas Unit</div>
            <input type="text" id="in-gi-name" disabled style="background:#f1f5f9; color:#64748b; cursor:not-allowed">
            <p style="font-size:11px; color:#94a3b8; margin-top:5px;">Nama unit tidak dapat diubah di sini.</p>
        </div>
        <div class="card">
            <div class="data-label">Backup Database</div>
            <p class="card-desc">Simpan data teks ke file JSON.</p>
            <button class="btn btn-primary" onclick="exportData()">‚¨áÔ∏è Download Backup JSON</button>
        </div>
        <div class="card">
            <div class="data-label">Restore Database</div>
            <input type="file" id="import-file" accept=".json">
            <button class="btn btn-secondary" onclick="importData(document.getElementById('import-file'))">üìÇ Upload File JSON</button>
        </div>
        <div class="card" style="background:#fff1f2; border-color:#fecdd3; margin-top:20px;">
            <div class="data-label" style="color:var(--danger)">Danger Zone</div>
            <button class="btn btn-danger" onclick="resetApp()">‚ö†Ô∏è Hapus Data Unit Ini</button>
        </div>
    </div>

</div>

<div id="modal-ann" class="overlay">
    <div class="modal">
        <h3>Form Annunciator</h3>
        <input type="hidden" id="ann-id"> 
        <label class="data-label">Unit / Bay</label>
        <input type="text" id="ann-unit" placeholder="Misal: Trafo 1">
        <label class="data-label">Nama Annunciator</label>
        <input type="text" id="ann-name" placeholder="Judul yang muncul di layar...">
        <label class="data-label">Maksud</label>
        <textarea id="ann-mean" rows="2" placeholder="Apa arti alarm ini?"></textarea>
        
        <label class="data-label">Indikasi</label>
        <textarea id="ann-ind" rows="2" placeholder="Indikasi Alarm"></textarea>
        
        <label class="data-label">Penyebab</label>
        <textarea id="ann-cause" rows="2" placeholder="Kemungkinan penyebab..."></textarea>
        <label class="data-label">Tindakan</label>
        <textarea id="ann-action" rows="2" placeholder="Langkah penanganan..."></textarea>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn btn-primary" onclick="saveAnnItem()">Simpan</button>
            <button class="btn btn-secondary" onclick="closeModal('modal-ann')">Batal</button>
        </div>
    </div>
</div>

<div id="modal-contact" class="overlay">
    <div class="modal">
        <h3>Data Kontak</h3>
        <input type="hidden" id="contact-id">
        <label class="data-label">Nama</label>
        <input type="text" id="contact-name" placeholder="Nama Personil / Instansi">
        <label class="data-label">Nomor Telepon</label>
        <input type="tel" id="contact-num" placeholder="08xxxx">
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn btn-primary" onclick="saveContactItem()">Simpan</button>
            <button class="btn btn-secondary" onclick="closeModal('modal-contact')">Batal</button>
        </div>
    </div>
</div>

<div id="loader"><div class="spinner"></div><div id="loader-text">Memproses...</div></div>
<div id="toast-container"></div>

<script>
// --- KONFIGURASI UNIT ---
const UNITS = [
    { id: 'fajar', name: 'GARDU INDUK 150 KV FAJAR SURYAWISESA', code: 'FJS' },
    { id: 'gandamekar', name: 'GARDU INDUK 150 KV GANDAMEKAR', code: 'GDM' },
    { id: 'cikarang', name: 'GARDU INDUK 150 KV CIKARANG', code: 'CKR' },
    { id: 'jababeka', name: 'GARDU INDUK 150 KV JABABEKA', code: 'JBK' },
    { id: 'rajapaksi', name: 'GARDU INDUK 150 KV RAJAPAKSI', code: 'RJP' },
    { id: 'poncol', name: 'GARDU INDUK 150 KV PONCOL BARU', code: 'PCB' },
    { id: 'tambun', name: 'GARDU INDUK 150 KV TAMBUN', code: 'TBN' },
    { id: 'margahayu', name: 'GIS 150 KV MARGAHAYU', code: 'MGH' },
    { id: 'new_tambun_tet', name: 'GISTET 500 KV NEW TAMBUN', code: 'NTB' },
    { id: 'muaratawar', name: 'GITET 500 KV MUARATAWAR', code: 'MRT' },
    { id: 'new_tambun_gis', name: 'GIS 150 KV NEW TAMBUN', code: 'NTG' }
];

// --- STATE MANAGEMENT ---
let currentUnit = null;
let db = { anns: [], contacts: [] }; 
let idb;

document.addEventListener('DOMContentLoaded', () => {
    setupSearchEngine();
    checkSession();
});

// --- SEARCH ENGINE LOGIC ---
function setupSearchEngine() {
    const input = document.getElementById('unit-search-input');
    const results = document.getElementById('unit-search-results');
    const searchWrapper = document.querySelector('.search-box');

    input.addEventListener('focus', () => {
        searchWrapper.style.borderRadius = "24px 24px 0 0";
        renderSearchResults(input.value);
        results.style.display = 'block';
    });

    input.addEventListener('input', (e) => { renderSearchResults(e.target.value); });

    document.addEventListener('click', (e) => {
        if (!e.target.closest('.search-wrapper')) {
            results.style.display = 'none';
            searchWrapper.style.borderRadius = "24px";
        }
    });
}

function renderSearchResults(keyword) {
    const list = document.getElementById('unit-search-results');
    list.innerHTML = '';
    const filtered = UNITS.filter(u => u.name.toLowerCase().includes(keyword.toLowerCase()));
    if (filtered.length === 0) {
        list.innerHTML = `<div class="search-item" style="color:var(--text-sub); justify-content:center">Unit tidak ditemukan</div>`;
        return;
    }
    filtered.forEach(u => {
        const div = document.createElement('div');
        div.className = 'search-item';
        div.innerHTML = `<div class="si-icon">${u.code}</div><div class="si-text"><div>${u.name}</div><div>GARDU INDUK</div></div>`;
        div.onclick = () => login(u.id);
        list.appendChild(div);
    });
}

function checkSession() {
    const lastUnit = localStorage.getItem('pandu_active_unit');
    if (lastUnit) login(lastUnit, false);
    else {
        document.getElementById('unit-select-screen').style.display = 'flex';
        document.getElementById('app-container').style.display = 'none';
        document.querySelector('.header').style.display = 'none';
    }
}

function login(unitId, animate = true) {
    const unit = UNITS.find(u => u.id === unitId);
    if(!unit) return;

    currentUnit = unit;
    localStorage.setItem('pandu_active_unit', unitId);

    const saved = localStorage.getItem(`pandu_db_${unitId}`);
    if (saved) {
        let tempDB = JSON.parse(saved);
        if(tempDB.alarms && !tempDB.anns) {
            tempDB.anns = tempDB.alarms.map(x => ({id: x.id||Date.now(), unit: x.s, name: x.a, mean: "", ind: x.m, cause: x.p, act: x.t}));
            delete tempDB.alarms;
        }
        db = tempDB;
        if(!db.anns) db.anns = [];
    } else { db = { anns: [], contacts: [] }; }

    initIndexedDB(unitId);

    document.getElementById('header-gi-name').innerText = unit.code;
    document.getElementById('gi-name-display').innerText = unit.name;
    document.getElementById('in-gi-name').value = unit.name;
    
    document.getElementById('unit-select-screen').style.display = 'none';
    document.getElementById('app-container').style.display = 'block';
    document.querySelector('.header').style.display = 'flex';
    goHome(); 
}

function switchUnit() { if(confirm("Ganti unit?")) { localStorage.removeItem('pandu_active_unit'); location.reload(); } }
function saveData() { if(!currentUnit) return; localStorage.setItem(`pandu_db_${currentUnit.id}`, JSON.stringify(db)); }
function initIndexedDB(unitId) {
    const request = indexedDB.open(`PanduGI_${unitId}`, 1);
    request.onupgradeneeded = e => { const d = e.target.result; if(!d.objectStoreNames.contains('sops')) d.createObjectStore("sops",{keyPath:"id",autoIncrement:true}); if(!d.objectStoreNames.contains('assets')) d.createObjectStore("assets",{keyPath:"id",autoIncrement:true}); };
    request.onsuccess = e => { idb = e.target.result; };
}

function showToast(msg, isError = false) {
    const container = document.getElementById('toast-container');
    const el = document.createElement('div'); el.className = `toast ${isError ? 'error' : ''}`; el.innerText = msg;
    container.appendChild(el); setTimeout(() => { el.style.opacity = '0'; el.style.transform = 'translateY(10px)'; setTimeout(() => el.remove(), 300); }, 3000);
}
function toggleLoader(show) { document.getElementById('loader').style.display = show ? 'flex' : 'none'; }
function goHome() { document.querySelectorAll('.app-section').forEach(el => el.classList.remove('active')); document.getElementById('main-menu').style.display = 'block'; document.getElementById('btn-back').style.display = 'none'; window.scrollTo(0,0); }
function openSection(id) { document.getElementById('main-menu').style.display = 'none'; document.getElementById(id).classList.add('active'); document.getElementById('btn-back').style.display = 'block'; window.scrollTo(0,0); if(id === 'section-annunciator') renderAnnunciator(); if(id === 'section-contact') renderContact(); if(id === 'section-sop') renderSOP(); if(id === 'section-asset') renderAsset(); }

// --- ANNUNCIATOR LOGIC ---
function renderAnnunciator() {
    const list = document.getElementById('list-ann');
    const key = document.getElementById('search-ann').value.toLowerCase();
    list.innerHTML = "";
    if (db.anns.length === 0) return list.innerHTML = "<div class='empty-state'>Belum ada data Annunciator.</div>";
    const filtered = db.anns.filter(x => (x.unit+" "+x.name+" "+x.mean+" "+x.ind+" "+x.cause+" "+x.act).toLowerCase().includes(key));
    if (filtered.length === 0) return list.innerHTML = "<div class='empty-state'>Tidak ditemukan.</div>";

    filtered.forEach((item) => {
        list.innerHTML += `
            <div class="card">
                <div class="action-group"><button class="icon-btn" onclick="editAnn('${item.id}')">‚úèÔ∏è</button><button class="icon-btn" onclick="delAnn('${item.id}')" style="color:var(--danger)">üóëÔ∏è</button></div>
                <div class="badge">${item.unit}</div><div class="card-title">${item.name}</div>
                <div class="data-row"><div class="data-label">Maksud</div><div class="data-val">${item.mean||'-'}</div></div>
                <div class="data-row"><div class="data-label">Indikasi</div><div class="data-val">${item.ind||'-'}</div></div>
                <div class="data-row"><div class="data-label">Penyebab</div><div class="data-val">${item.cause||'-'}</div></div>
                <div class="data-row"><div class="data-label">Tindakan</div><div class="data-val">${item.act||'-'}</div></div>
            </div>`;
    });
}
function saveAnnItem() {
    const id = document.getElementById('ann-id').value;
    const item = { id: id||Date.now().toString(), unit: document.getElementById('ann-unit').value, name: document.getElementById('ann-name').value, mean: document.getElementById('ann-mean').value, ind: document.getElementById('ann-ind').value, cause: document.getElementById('ann-cause').value, act: document.getElementById('ann-action').value };
    if(!item.unit || !item.name) return showToast("Lengkapi data!", true);
    if (id) { const idx = db.anns.findIndex(x => x.id == id); if(idx !== -1) db.anns[idx] = item; } else { db.anns.unshift(item); }
    saveData(); closeModal('modal-ann'); renderAnnunciator(); showToast("Tersimpan!");
}
function editAnn(id) {
    const item = db.anns.find(x => x.id == id); if (!item) return;
    document.getElementById('ann-id').value = item.id;
    document.getElementById('ann-unit').value = item.unit;
    document.getElementById('ann-name').value = item.name;
    document.getElementById('ann-mean').value = item.mean||"";
    document.getElementById('ann-ind').value = item.ind;
    document.getElementById('ann-cause').value = item.cause;
    document.getElementById('ann-action').value = item.act;
    openModal('modal-ann');
}
function delAnn(id) { if(confirm("Hapus?")) { db.anns = db.anns.filter(x => x.id != id); saveData(); renderAnnunciator(); } }

function renderContact() { const list = document.getElementById('list-contact'); list.innerHTML = ""; if (db.contacts.length === 0) return list.innerHTML = "<div class='empty-state'>Belum ada kontak.</div>"; db.contacts.forEach((item) => { list.innerHTML += `<div class="card" style="display:flex; justify-content:space-between; align-items:center"><div><div class="data-val" style="font-weight:700">${item.name}</div><a href="tel:${item.no}" style="color:var(--primary);font-weight:600;text-decoration:none;font-size:13px">${item.no}</a></div><button class="icon-btn" onclick="delContact('${item.id}')" style="color:var(--danger)">‚úï</button></div>`; }); }
function saveContactItem() { const item = { id: Date.now().toString(), name: document.getElementById('contact-name').value, no: document.getElementById('contact-num').value }; if(!item.name) return showToast("Isi nama", true); db.contacts.push(item); saveData(); closeModal('modal-contact'); renderContact(); }
function delContact(id) { if(confirm("Hapus?")) { db.contacts = db.contacts.filter(x => x.id != id); saveData(); renderContact(); } }

function saveFile(storeName, nameId, fileId, renderFunc) {
    const name = document.getElementById(nameId).value; const file = document.getElementById(fileId).files[0];
    if(!name || !file) return showToast("Lengkapi data!", true); if(file.size > 10*1024*1024) return showToast("Maks 10 MB!", true); if(file.type!=="application/pdf") return showToast("Wajib PDF!", true);
    toggleLoader(true);
    const reader = new FileReader();
    reader.onload = function(e) {
        try { const tx = idb.transaction(storeName, "readwrite"); tx.objectStore(storeName).add({ name: name, blob: new Blob([e.target.result], {type: 'application/pdf'}), date: new Date().toLocaleDateString() }); tx.oncomplete=()=>{toggleLoader(false);showToast("Berhasil!");document.getElementById(nameId).value="";document.getElementById(fileId).value="";renderFunc();}; tx.onerror=()=>{toggleLoader(false);showToast("Gagal (Full?)",true);} } catch(err) {toggleLoader(false);showToast("Error",true);}
    }; reader.readAsArrayBuffer(file);
}
function renderFile(storeName, listId, delFunc) {
    const list = document.getElementById(listId); list.innerHTML = "<div class='spinner' style='width:20px;height:20px;margin:20px auto'></div>";
    if(!idb) { setTimeout(() => renderFile(storeName, listId, delFunc), 500); return; }
    const tx = idb.transaction(storeName, "readonly");
    tx.objectStore(storeName).getAll().onsuccess = e => {
        const res = e.target.result; res.sort((a, b) => b.id - a.id); list.innerHTML = res.length ? "" : "<div class='empty-state'>Kosong.</div>";
        res.forEach(f => { list.innerHTML += `<div class="card" style="display:flex;justify-content:space-between;align-items:center"><div style="overflow:hidden;padding-right:10px"><div class="data-val" style="margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:700">${f.name}</div><div class="data-label" style="font-size:10px;margin-top:2px">${f.date}</div></div><div style="display:flex;gap:5px"><button class="btn btn-secondary" style="margin:0;padding:8px 12px;font-size:12px" onclick="openFile('${storeName}',${f.id})">Buka</button><button class="btn btn-danger" style="margin:0;padding:8px;width:36px;display:flex;justify-content:center" onclick="${delFunc}(${f.id})">‚úï</button></div></div>`; });
    };
}
function openFile(storeName, id) { toggleLoader(true); const tx = idb.transaction(storeName, "readonly"); tx.objectStore(storeName).get(id).onsuccess = e => { toggleLoader(false); if(e.target.result) { const url = URL.createObjectURL(e.target.result.blob); const win = window.open(url, '_blank', 'noopener,noreferrer'); if(!win) location.href = url; setTimeout(() => URL.revokeObjectURL(url), 60000); } else showToast("Gagal buka", true); }; }
function delFile(storeName, id, renderFunc) { if(confirm("Hapus?")) { const tx = idb.transaction(storeName, "readwrite"); tx.objectStore(storeName).delete(id).onsuccess = () => renderFunc(); } }
function saveSOP() { saveFile('sops', 'sop-name', 'sop-file', renderSOP); } function renderSOP() { renderFile('sops', 'list-sop', 'delSOP'); } function delSOP(id) { delFile('sops', id, renderSOP); }
function saveAsset() { saveFile('assets', 'asset-name', 'asset-file', renderAsset); } function renderAsset() { renderFile('assets', 'list-asset', 'delAsset'); } function delAsset(id) { delFile('assets', id, renderAsset); }

function exportData() { const str = JSON.stringify(db, null, 2); const blob = new Blob([str], {type: "application/json"}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `BACKUP_${currentUnit.code}.json`; document.body.appendChild(a); a.click(); a.remove(); }
function importData(input) { const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = e => { try { const json = JSON.parse(e.target.result); if(confirm(`Timpa data ${currentUnit.name}?`)) { if(json.alarms && !json.anns) { json.anns = json.alarms.map(x => ({id:x.id, unit:x.s, name:x.a, mean:"", ind:x.m, cause:x.p, act:x.t})); delete json.alarms; } db = json; saveData(); location.reload(); } } catch(err) { showToast("File rusak", true); } }; reader.readAsText(file); }
function resetApp() { if(confirm("RESET TOTAL UNIT INI?")) { localStorage.removeItem(`pandu_db_${currentUnit.id}`); indexedDB.deleteDatabase(`PanduGI_${currentUnit.id}`).onsuccess = () => location.reload(); } }

function openModal(id) { document.getElementById(id).style.display = 'flex'; if(id==='modal-ann') ['ann-id','ann-unit','ann-name','ann-mean','ann-ind','ann-cause','ann-action'].forEach(k=>document.getElementById(k).value=""); if(id==='modal-contact') ['contact-id','contact-name','contact-num'].forEach(k=>document.getElementById(k).value=""); }
function closeModal(id) { document.getElementById(id).style.display = 'none'; }
window.onclick = e => { if(e.target.classList.contains('overlay')) e.target.style.display="none"; }
</script>
</body>
</html>
